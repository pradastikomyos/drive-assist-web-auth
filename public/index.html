<!-- public/index.html -->
<script>
    console.log('Auth callback page loaded');
    
    const urlParams = new URLSearchParams(window.location.search);
    const fragment = new URLSearchParams(window.location.hash.substring(1));
    
    const statusEl = document.getElementById('status');
    const resultEl = document.getElementById('result');
    const debugEl = document.getElementById('debug');
    const spinnerEl = document.getElementById('spinner');
    
    const debugInfo = {
        url: window.location.href,
        search: window.location.search,
        hash: window.location.hash,
        urlParams: Object.fromEntries(urlParams),
        fragment: Object.fromEntries(fragment)
    };
    
    console.log('Debug info:', debugInfo);
    debugEl.innerHTML = JSON.stringify(debugInfo, null, 2);
    
    setTimeout(() => {
        if (statusEl.textContent === 'Authenticating...') {
            debugEl.style.display = 'block';
            statusEl.textContent = 'Debug Mode - Check URL parameters';
        }
    }, 3000);
    
    const accessToken = fragment.get('access_token') || urlParams.get('access_token');
    const refreshToken = fragment.get('refresh_token') || urlParams.get('refresh_token');
    const error = fragment.get('error') || urlParams.get('error');
    const errorDescription = fragment.get('error_description') || urlParams.get('error_description');
    const code = urlParams.get('code');
    
    console.log('Parsed tokens:', { accessToken, refreshToken, error, errorDescription, code });
    
    if (error) {
        console.error('Authentication error:', error, errorDescription);
        spinnerEl.style.display = 'none';
        statusEl.textContent = 'Authentication Failed';
        // FIX: Menggunakan backtick untuk string HTML
        resultEl.innerHTML = `<div class="error">Error: ${errorDescription || error}</div>`;
        
    } else if (accessToken) {
        console.log('Access token found, authentication successful');
        spinnerEl.style.display = 'none';
        statusEl.textContent = 'Authentication Successful!';
        // FIX: Menggunakan backtick untuk string HTML
        resultEl.innerHTML = `
            <div class="success">Successfully authenticated</div>
            <p>Redirecting back to app...</p>
        `;
        
        setTimeout(() => {
            console.log('Attempting deep link redirect');
            // FIX: URL harus dalam bentuk string
            window.location.href = 'io.supabase.flutterquickstart://login-callback/';
            
            setTimeout(() => {
                resultEl.innerHTML += '<p><small>If the app didn\'t open, please close this window and return to the app.</small></p>';
            }, 3000);
        }, 2000);
        
    } else if (code) {
        console.log('Authorization code found:', code);
        spinnerEl.style.display = 'none';
        statusEl.textContent = 'Authentication Successful!';
        // FIX: Menggunakan backtick untuk string HTML
        resultEl.innerHTML = `
            <div class="success">Authorization successful</div>
            <p>Redirecting back to app...</p>
        `;

        setTimeout(() => {
            console.log('Attempting deep link redirect with code');
            // FIX: Menggunakan template literal untuk menyisipkan kode ke URL
            window.location.href = `io.supabase.flutterquickstart://login-callback/?code=${code}`;
            
            setTimeout(() => {
                resultEl.innerHTML += '<p><small>If the app didn\'t open, please close this window and return to the app.</small></p>';
            }, 3000);
        }, 2000);
        
    } else {
        console.log('No tokens or code found, still processing...');
        setTimeout(() => {
            if (!accessToken && !code && !error) {
                spinnerEl.style.display = 'none';
                statusEl.textContent = 'Waiting for authentication...';
                // FIX: Menggunakan backtick untuk string HTML
                resultEl.innerHTML = `
                    <div class="error">No authentication data received</div>
                    <p>Please try closing this window and signing in again.</p>
                `;
            }
        }, 10000);
    }
</script>
